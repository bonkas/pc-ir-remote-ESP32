# ESPHome config for PC IR Remote — ESP32-C3 Super Mini
# See CONTEXT.md for full project background and wiring notes.
#
# SETUP STEPS:
# 1. Flash this config to your ESP32-C3
# 2. Open ESPHome logs and point your remote at the TSOP38238
# 3. Press each button you want to use — codes appear in the log (dump: all)
# 4. Note the protocol, address, and command for each button
# 5. Add a binary_sensor entry for each IR button (see IR BUTTONS section below)
# 6. Comment out or remove 'dump: all' once codes are captured, then reflash

# =============================================================================
# DEVICE
# =============================================================================

esphome:
  name: pc-ir-remote
  friendly_name: PC IR Remote

esp32:
  board: lolin_c3_mini
  variant: ESP32C3
  framework:
    type: arduino

# =============================================================================
# CONNECTIVITY
# =============================================================================

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "PC-IR-Remote Fallback"
    password: "changeme123"

captive_portal:

api:
  encryption:
    key: !secret api_key

ota:
  - platform: esphome
    password: !secret ota_password

logger:
  level: DEBUG

# =============================================================================
# IR RECEIVER — TSOP38238
# Wiring: OUT → GPIO3 (inverted: true, TSOP output is active-low)
#         VS  → 3.3V via 100Ω series resistor
#         GND → GND
#         100nF ceramic cap between VS and GND, as close to the IC as possible.
#
# IR code matching is handled via binary_sensor entries below (see IR BUTTONS).
# =============================================================================

remote_receiver:
  - pin:
      number: GPIO3
      inverted: true
    dump: all  # comment out after learning your remote codes

# =============================================================================
# RELAY OUTPUTS
# Both relays are active-low (relay fires on LOW).
# restore_mode: ALWAYS_OFF ensures relays never turn on during a reboot.
# NOTE: GPIO2 is a strapping pin on ESP32-C3. If boot issues occur,
#       add a 10kΩ pull-up resistor between GPIO2 and 3.3V.
# =============================================================================

switch:
  - platform: gpio
    pin:
      number: GPIO1
      inverted: true       # relay fires on LOW
    id: power_relay
    name: "PC Power Relay"
    icon: "mdi:electric-switch"
    restore_mode: ALWAYS_OFF

  - platform: gpio
    pin:
      number: GPIO2
      inverted: true       # relay fires on LOW
    id: reset_relay
    name: "PC Reset Relay"
    icon: "mdi:electric-switch"
    restore_mode: ALWAYS_OFF

# =============================================================================
# PULSE BUTTONS
# Template buttons that fire the relay for 500ms — simulates a real button
# press. Use these from HA, IR automations, and physical button triggers.
# The status LED flashes once during the pulse.
# =============================================================================

button:
  - platform: template
    name: "PC Power Button"
    id: pc_power_button
    icon: "mdi:power"
    on_press:
      - light.turn_on: status_led
      - switch.turn_on: power_relay
      - delay: 500ms
      - switch.turn_off: power_relay
      - light.turn_off: status_led

  - platform: template
    name: "PC Reset Button"
    id: pc_reset_button
    icon: "mdi:restart"
    on_press:
      - light.turn_on: status_led
      - switch.turn_on: reset_relay
      - delay: 500ms
      - switch.turn_off: reset_relay
      - light.turn_off: status_led

# =============================================================================
# BINARY SENSORS
# Includes both physical buttons and IR remote buttons.
#
# IR BUTTONS — add one entry per remote button using the protocol and codes
# from the 'dump: all' logs. Replace 'nec' with your protocol if different
# (samsung, rc5, sony, etc.) and fill in address/command values.
#
# PHYSICAL BUTTONS — GPIO5 and GPIO6 act as direct manual relay triggers.
# In the Arduino sketch these enter IR learn mode; in ESPHome IR codes are
# configured here in YAML so the buttons trigger the relay directly instead.
# =============================================================================

binary_sensor:
  # --- IR remote buttons (add one block per button) ---
  # internal: true hides the entity from HA — it still triggers the relay.
  # - platform: remote_receiver
  #   name: "IR Power Button"
  #   internal: true
  #   nec:
  #     address: 0x????
  #     command: 0x????
  #   on_press:
  #     - button.press: pc_power_button

  # - platform: remote_receiver
  #   name: "IR Reset Button"
  #   internal: true
  #   nec:
  #     address: 0x????
  #     command: 0x????
  #   on_press:
  #     - button.press: pc_reset_button

  # --- Physical buttons ---
  # internal: true hides these from HA — they still trigger the relay when pressed.
  - platform: gpio
    pin:
      number: GPIO5
      mode: INPUT_PULLUP
      inverted: true       # active-low
    name: "Power Button (Physical)"
    internal: true
    filters:
      - delayed_on: 20ms   # debounce
    on_press:
      - button.press: pc_power_button

  - platform: gpio
    pin:
      number: GPIO6
      mode: INPUT_PULLUP
      inverted: true       # active-low
    name: "Reset Button (Physical)"
    internal: true
    filters:
      - delayed_on: 20ms   # debounce
    on_press:
      - button.press: pc_reset_button

# =============================================================================
# STATUS LED
# GPIO7 → 330Ω → LED → GND  (external LED)
# Change GPIO7 to GPIO8 to use the onboard LED_BUILTIN instead.
# The light entity is controlled from button automations above.
# =============================================================================

output:
  - platform: gpio
    pin: GPIO7
    id: status_led_output

light:
  - platform: binary
    name: "Status LED"
    id: status_led
    output: status_led_output
